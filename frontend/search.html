<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä —Ç–æ—á–∫–∏ | –ö–æ—Å–º–æ—Å –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        main {
            padding: 100px 40px 40px;
        }

        @media (max-width: 768px) {
            main {
                padding: 80px 20px 20px;
            }
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent-blue);
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: #a0aec0;
            margin-bottom: 30px;
        }

        .stars-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            background: #000000;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.6;
            animation: twinkle 3s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .search-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }

        @media (max-width: 992px) {
            .search-container {
                grid-template-columns: 1fr;
            }
        }

        .search-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-panel {
            background: var(--glass);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        .panel-header {
            margin-bottom: 20px;
        }

        .panel-title {
            color: var(--accent-blue);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .panel-subtitle {
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .method-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .method-tab {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .method-tab:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: var(--accent-blue);
        }

        .method-tab.active {
            background: rgba(74, 158, 255, 0.2);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .method-content {
            display: none;
        }

        .method-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .map-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-container {
            height: 500px;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--glass-border);
            background: #f0f0f0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .point-info-panel {
            background: var(--glass);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .info-label {
            color: #a0aec0;
            font-size: 0.85rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-value {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            font-family: 'Space Grotesk', sans-serif;
        }

        .info-value.coords {
            font-family: 'Space Grotesk', monospace;
            font-size: 0.9rem;
            color: var(--accent-blue);
        }

        .save-section {
            margin-top: 30px;
            text-align: center;
        }

        .btn-save {
            padding: 15px 40px;
            font-size: 1.1rem;
            min-width: 250px;
        }

        .message {
            text-align: center;
            padding: 12px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            display: block;
        }

        .message.error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            display: block;
        }

        .instructions {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .instructions h4 {
            color: var(--accent-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions p {
            color: #a0aec0;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        /* –£–±–∏—Ä–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø Leaflet */
        .leaflet-control-attribution.leaflet-control {
            visibility: hidden !important;
        }
    </style>
</head>
<body>
    <div class="stars-container" id="stars"></div>

    <header>
        <div class="header-logo">
            <i class="fas fa-satellite"></i>
            –ö–û–°–ú–û–° –ú–û–ù–ò–¢–û–†–ò–ù–ì
        </div>
        <div class="header-actions">
            <nav class="nav-menu">
                <a href="index.html"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a>
                <a href="search.html" class="active"><i class="fas fa-search"></i> –í—ã–±–æ—Ä —Ç–æ—á–∫–∏</a>
                <a href="territories.html"><i class="fas fa-map-marked-alt"></i> –ú–æ–∏ —Ç–æ—á–∫–∏</a>
                <a href="analysis.html"><i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏–∑</a>
                <a href="cabinet.html"><i class="fas fa-user"></i> –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
            </nav>
            <div class="user-section">
                <span class="user-info" id="userInfo"></span>
                <button class="btn btn-outline btn-small" id="authBtn">–í–æ–π—Ç–∏</button>
            </div>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <button class="auth-close" id="closeAuth">&times;</button>
            <div id="loginForm">
                <h2 class="auth-title">–í—Ö–æ–¥</h2>
                <p class="auth-subtitle">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π</p>
                <form id="loginFormElement">
                    <div class="form-group">
                        <label>–õ–æ–≥–∏–Ω</label>
                        <input type="text" id="loginUsername" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">–í–æ–π—Ç–∏</button>
                </form>
                <div class="auth-switch">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="switchToRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </div>
            </div>

            <div id="registerForm" style="display: none;">
                <h2 class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p class="auth-subtitle">–ù–∞—á–Ω–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è</p>
                <form id="registerFormElement">
                    <div class="form-group">
                        <label>–õ–æ–≥–∏–Ω</label>
                        <input type="text" id="registerUsername" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                        <input type="password" id="registerPasswordConfirm" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </form>
                <div class="auth-switch">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="switchToLogin">–í–æ–π—Ç–∏</a>
                </div>
            </div>
        </div>
    </div>

    <main>
        <div class="page-header">
            <h1 class="page-title">–í—ã–±–æ—Ä —Ç–æ—á–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h1>
            <p class="page-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–ª–∏ –∞–¥—Ä–µ—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
        </div>

        <div class="search-container">
            <div class="search-controls">
                <div class="control-panel">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <i class="fas fa-sliders-h"></i> –í—ã–±–æ—Ä —Ç–æ—á–∫–∏
                        </h3>
                        <p class="panel-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥ —É–∫–∞–∑–∞–Ω–∏—è —Ç–æ—á–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
                    </div>

                    <div class="method-selector">
                        <div class="method-tab active" data-method="map">
                            <i class="fas fa-map-marker-alt"></i> –£–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                        </div>
                        <div class="method-tab" data-method="coords">
                            <i class="fas fa-crosshairs"></i> –í–≤–µ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        </div>
                        <div class="method-tab" data-method="address">
                            <i class="fas fa-map-pin"></i> –í–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å
                        </div>
                    </div>

                    <div id="mapMethod" class="method-content active">
                        <div class="instructions">
                            <h4><i class="fas fa-info-circle"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h4>
                            <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.</p>
                        </div>
                    </div>

                    <div id="coordsMethod" class="method-content">
                        <div class="form-group">
                            <label>–®–∏—Ä–æ—Ç–∞ (latitude)</label>
                            <input type="text" id="coordLat" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 55.7558" value="55.7558">
                        </div>
                        <div class="form-group">
                            <label>–î–æ–ª–≥–æ—Ç–∞ (longitude)</label>
                            <input type="text" id="coordLng" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 37.6173" value="37.6173">
                        </div>
                        <button id="applyCoordsBtn" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        </button>
                    </div>

                    <div id="addressMethod" class="method-content">
                        <div class="form-group">
                            <label>–ê–¥—Ä–µ—Å</label>
                            <input type="text" id="addressInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å">
                        </div>
                        <button id="searchAddressBtn" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                        </button>
                    </div>
                </div>

                <div class="control-panel">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–∫–µ
                        </h3>
                        <p class="panel-subtitle">–î–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-map-marker-alt"></i> –°—Ç–∞—Ç—É—Å
                            </div>
                            <div class="info-value" id="pointStatus">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-crosshairs"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                            </div>
                            <div class="info-value coords" id="pointCoords">‚Äî</div>
                        </div>
                    </div>
                </div>

                <div class="save-section">
                    <div class="form-group">
                        <input type="text" id="territoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏" value="–ú–æ—è —Ç–æ—á–∫–∞">
                    </div>
                    <button id="saveTerritoryBtn" class="btn btn-success btn-save" disabled>
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ—á–∫—É
                    </button>
                    <div id="saveMessage" class="message"></div>
                </div>
            </div>

            <div class="map-section">
                <div class="map-container">
                    <div id="map"></div>
                </div>

                <div class="point-info-panel">
                    <h3 class="panel-title">
                        <i class="fas fa-map"></i> –ö–∞—Ä—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                    </h3>
                    <p class="panel-subtitle" id="mapInstructions">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
                </div>
            </div>
        </div>
    </main>

    <footer>¬© 2026 –ö–æ—Å–º–æ—Å –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | –°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="script.js"></script>
    <script>
        function initMap() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã
                if (!document.getElementById('map')) {
                    console.error('–≠–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã - –ú–æ—Å–∫–≤–∞
                map = L.map('map', {
                    attributionControl: false // –û–¢–ö–õ–Æ–ß–ê–ï–ú –ê–¢–†–ò–ë–£–¶–ò–Æ!
                }).setView([55.7558, 37.6176], 10);

                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ü–≤–µ—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ OpenStreetMap –ë–ï–ó –ê–¢–†–ò–ë–£–¶–ò–ò
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '' // –ü–£–°–¢–ê–Ø –°–¢–†–û–ö–ê - –û–¢–ö–õ–Æ–ß–ê–ï–ú –ù–ê–î–ü–ò–°–¨
                }).addTo(map);

                // –Ø–í–ù–û –û–¢–ö–õ–Æ–ß–ê–ï–ú –ö–û–ù–¢–†–û–õ–¨ –ê–¢–†–ò–ë–£–¶–ò–ò
                map.attributionControl.setPrefix(false);
                map.attributionControl.removeAttribution('OpenStreetMap');

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.on('click', function(e) {
                    selectPointOnMap(e.latlng);
                });

                console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (–∞—Ç—Ä–∏–±—É—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞)');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            }
        }
        // JavaScript –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏
        let map, marker;
        let selectedPoint = null;

        function pageSpecificInit() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∏—Å–∫–∞...');
            initMap();
            initControls();
        }
        async function loadAllImagesForTerritory() {
            if (!currentPointId) return;

            try {
                const response = await fetch(`/api/territories/${currentPointId}/images/all`);
                const data = await response.json();

                if (data.success) {
                    currentImages = data.images;
                    updateImageNavigation();
                    displayCurrentImage();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', data.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
            }
        }

        async function selectComparisonImage() {
            if (availableImages.length === 0) {
                await loadAllImagesForTerritory();
            }

            if (availableImages.length <= 1) {
                showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫
            const otherImages = availableImages.filter(img =>
                img.id !== availableImages[currentImageIndex].id
            );

            if (otherImages.length === 0) {
                showNotification('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —Å–Ω–∏–º–∫–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞
            const dialog = document.createElement('div');
            dialog.innerHTML = `
                <div class="comparison-dialog-overlay">
                    <div class="comparison-dialog">
                        <div class="comparison-dialog-header">
                            <h3><i class="fas fa-history"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∏–º–æ–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</h3>
                            <button class="dialog-close">&times;</button>
                        </div>

                        <div class="comparison-dialog-info">
                            –¢–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫: <strong>${formatDate(new Date(availableImages[currentImageIndex].date))}</strong>
                        </div>

                        <div id="comparisonImagesList" class="comparison-images-list">
                            <!-- –°–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                        </div>

                        <div class="comparison-dialog-footer">
                            <button class="dialog-cancel">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞
            dialog.querySelector('.dialog-close').onclick = () => dialog.remove();
            dialog.querySelector('.dialog-cancel').onclick = () => dialog.remove();
            dialog.querySelector('.comparison-dialog-overlay').onclick = (e) => {
                if (e.target.classList.contains('comparison-dialog-overlay')) dialog.remove();
            };

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const listContainer = document.getElementById('comparisonImagesList');
            listContainer.innerHTML = '';

            otherImages.forEach((img) => {
                const imgElement = document.createElement('div');
                imgElement.className = 'comparison-image-item';
                if (selectedComparisonImageId === img.id) {
                    imgElement.classList.add('selected');
                }

                imgElement.innerHTML = `
                    <div class="comparison-image-content">
                        <div>
                            <strong>${formatDate(new Date(img.date))}</strong>
                            <div class="image-meta">
                                ${img.cloud_cover ? `<span><i class="fas fa-cloud"></i> ${img.cloud_cover}%</span>` : ''}
                                <span><i class="fas fa-hdd"></i> ${img.file_size}</span>
                                <span><i class="fas fa-file"></i> ${img.file_type}</span>
                            </div>
                        </div>
                        <div class="image-check">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                `;

                imgElement.onclick = () => {
                    selectImageForComparison(img.id);
                    dialog.remove();
                };

                listContainer.appendChild(imgElement);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
            const style = document.createElement('style');
            style.textContent = `
                .comparison-dialog-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease;
                }

                .comparison-dialog {
                    background: var(--glass);
                    border-radius: 16px;
                    padding: 25px;
                    width: 600px;
                    max-width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 2px solid var(--accent-blue);
                    animation: slideUp 0.3s ease;
                }

                .comparison-dialog-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                }

                .comparison-dialog-header h3 {
                    color: var(--accent-blue);
                    margin: 0;
                    font-size: 1.2rem;
                }

                .dialog-close {
                    background: transparent;
                    border: none;
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                }

                .dialog-close:hover {
                    background: rgba(255,255,255,0.1);
                }

                .comparison-dialog-info {
                    margin-bottom: 15px;
                    color: #a0aec0;
                    padding: 10px;
                    background: rgba(0,0,0,0.2);
                    border-radius: 8px;
                }

                .comparison-images-list {
                    display: grid;
                    gap: 10px;
                    max-height: 400px;
                    overflow-y: auto;
                    padding-right: 5px;
                }

                .comparison-image-item {
                    padding: 15px;
                    background: rgba(0, 0, 0, 0.4);
                    border: 1px solid var(--glass-border);
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }

                .comparison-image-item:hover {
                    border-color: var(--accent-blue);
                    transform: translateX(5px);
                }

                .comparison-image-item.selected {
                    background: rgba(74, 158, 255, 0.2);
                    border-color: var(--accent-blue);
                }

                .comparison-image-content {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .image-meta {
                    font-size: 0.85rem;
                    color: #a0aec0;
                    margin-top: 5px;
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                }

                .image-meta span {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                }

                .image-check .fa-check {
                    color: var(--accent-blue);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .comparison-image-item.selected .image-check .fa-check {
                    opacity: 1;
                }

                .comparison-dialog-footer {
                    margin-top: 20px;
                    text-align: center;
                }

                .dialog-cancel {
                    background: transparent;
                    border: 1px solid var(--glass-border);
                    color: white;
                    padding: 10px 30px;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }

                .dialog-cancel:hover {
                    border-color: var(--accent-blue);
                    background: rgba(74, 158, 255, 0.1);
                }

                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }

                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;

            document.head.appendChild(style);
        }

        async function selectImageForComparison(imageId) {
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const index = availableImages.findIndex(img => img.id === imageId);
            if (index === -1) {
                showNotification('–û—à–∏–±–∫–∞: —Å–Ω–∏–º–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            selectedComparisonImageId = imageId;
            comparisonImageIndex = index;

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞
            await displayComparisonImage();

            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            document.getElementById('compareButton').disabled = false;

            showNotification(
                `–í—ã–±—Ä–∞–Ω —Å–Ω–∏–º–æ–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –æ—Ç ${formatDate(new Date(availableImages[index].date))}`,
                'success'
            );
        }

        async function compareImages() {
            if (!currentPointId || !selectedComparisonImageId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∏–º–æ–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ —Å–Ω–∏–º–∫–∞
            const currentImageId = availableImages[currentImageIndex].id;

            if (currentImageId === selectedComparisonImageId) {
                showNotification('–ù–µ–ª—å–∑—è —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å–Ω–∏–º–æ–∫ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π', 'error');
                return;
            }

            try {
                showNotification('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...', 'info');

                const response = await fetch('/api/analysis/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        territory_id: currentPointId,
                        current_image_id: currentImageId,
                        comparison_image_id: selectedComparisonImageId,
                        detector: 'improved'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const result = data.comparison;
                    const percent = result.change_percentage || result.real_change_percentage || 0;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                    updateComparisonResults(result, percent, data);

                    showNotification('–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', 'error');
            }
        }

        function updateComparisonResults(result, percent, apiData) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            const percentageElement = document.getElementById('changePercentage');
            const detailsElement = document.getElementById('changeDetails');
            const resultContainer = document.getElementById('comparisonResult');

            if (!percentageElement || !detailsElement || !resultContainer) return;

            percentageElement.textContent = `${percent.toFixed(1)}% –∏–∑–º–µ–Ω–µ–Ω–∏–π`;

            let details = `–£—Ä–æ–≤–µ–Ω—å: ${result.change_level || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
            if (result.change_type) {
                details += ` ‚Ä¢ –¢–∏–ø: ${result.change_type}`;
            }
            if (result.is_seasonal) {
                details += ` ‚Ä¢ –°–µ–∑–æ–Ω–Ω—ã–µ`;
            }

            detailsElement.textContent = details;

            // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞
            percentageElement.className = 'status-badge-large ';

            if (percent > 20) {
                percentageElement.classList.add('status-critical-bg');
            } else if (percent > 5) {
                percentageElement.classList.add('status-warning-bg');
            } else {
                percentageElement.classList.add('status-stable-bg');
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            resultContainer.style.display = 'block';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            lastComparisonResult = {
                data: result,
                apiData: apiData,
                percent: percent
            };
        }

        function showComparisonDetails() {
            if (!lastComparisonResult) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤');
                return;
            }

            const result = lastComparisonResult;
            const details = [];

            details.push(` –†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–†–ê–í–ù–ï–ù–ò–Ø:`);
            details.push(`–ò–∑–º–µ–Ω–µ–Ω–∏—è: ${result.percent.toFixed(2)}%`);
            details.push(`–£—Ä–æ–≤–µ–Ω—å: ${result.data.change_level || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);

            if (result.data.change_type) {
                details.push(`–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π: ${result.data.change_type}`);
            }

            if (result.data.significance) {
                details.push(`–ó–Ω–∞—á–∏–º–æ—Å—Ç—å: ${result.data.significance}`);
            }

            if (result.data.is_seasonal !== undefined) {
                details.push(`–°–µ–∑–æ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: ${result.data.is_seasonal ? '–î–∞' : '–ù–µ—Ç'}`);
            }

            if (result.data.details) {
                details.push(`\n –î–ï–¢–ê–õ–ò:`);
                Object.entries(result.data.details).forEach(([key, value]) => {
                    details.push(`${key}: ${value}`);
                });
            }

            if (result.apiData.visualization_url) {
                details.push(`\nüëÅ –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø:`);
                details.push(`–î–æ—Å—Ç—É–ø–Ω–∞ –ø–æ —Å—Å—ã–ª–∫–µ: ${window.location.origin}${result.apiData.visualization_url}`);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∫—Ä–∞—Å–∏–≤–æ–º –¥–∏–∞–ª–æ–≥–µ
            const dialog = document.createElement('div');
            dialog.innerHTML = `
                <div class="comparison-dialog-overlay">
                    <div class="comparison-dialog" style="max-width: 500px;">
                        <div class="comparison-dialog-header">
                            <h3><i class="fas fa-chart-bar"></i> –î–µ—Ç–∞–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</h3>
                            <button class="dialog-close">&times;</button>
                        </div>

                        <div class="comparison-results-details">
                            ${details.map(line => `<div class="result-line">${line}</div>`).join('')}
                        </div>

                        <div class="comparison-dialog-footer">
                            <button class="dialog-cancel">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞
            dialog.querySelector('.dialog-close').onclick = () => dialog.remove();
            dialog.querySelector('.dialog-cancel').onclick = () => dialog.remove();
            dialog.querySelector('.comparison-dialog-overlay').onclick = (e) => {
                if (e.target.classList.contains('comparison-dialog-overlay')) dialog.remove();
            };

            // –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
            const style = document.createElement('style');
            style.textContent = `
                .comparison-results-details {
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 10px;
                    background: rgba(0,0,0,0.2);
                    border-radius: 8px;
                    font-family: 'Space Grotesk', monospace;
                }

                .result-line {
                    padding: 5px 0;
                    color: #a0aec0;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                }

                .result-line:last-child {
                    border-bottom: none;
                }
            `;

            document.head.appendChild(style);
        }

        async function quickCompare() {
            if (!currentPointId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'error');
                return;
            }

            try {
                showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–Ω–∏–º–∫–æ–≤...', 'info');

                const response = await fetch('/api/analysis/quick-compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        territory_id: currentPointId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const result = data.comparison;
                    const percent = result.change_percentage || 0;

                    updateComparisonResults(result, percent, data);
                    showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏', 'error');
            }
        }
        function initMap() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã
                if (!document.getElementById('map')) {
                    console.error('–≠–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã - –ú–æ—Å–∫–≤–∞
                map = L.map('map').setView([55.7558, 37.6176], 10);

                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ü–≤–µ—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ OpenStreetMap
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.on('click', function(e) {
                    selectPointOnMap(e.latlng);
                });

                console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            }
        }

        function selectPointOnMap(latlng) {
            selectedPoint = latlng;

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä
            if (marker) map.removeLayer(marker);

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            marker = L.marker(latlng, {
                icon: L.divIcon({
                    html: '<i class="fas fa-crosshairs" style="color: #ff4444; font-size: 24px;"></i>',
                    iconSize: [24, 24],
                    className: 'custom-marker'
                })
            }).addTo(map);

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–æ—á–∫–µ
            map.setView(latlng, 14);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            updatePointInfo();

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            document.getElementById('saveTerritoryBtn').disabled = false;
        }

        function initControls() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');

                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É
                    document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
                    document.querySelectorAll('.method-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(method + 'Method').classList.add('active');

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ
                    updateMapInstructions(method);
                });
            });

            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            document.getElementById('applyCoordsBtn').addEventListener('click', function() {
                const lat = parseFloat(document.getElementById('coordLat').value.replace(',', '.'));
                const lng = parseFloat(document.getElementById('coordLng').value.replace(',', '.'));

                if (isNaN(lat) || isNaN(lng)) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã', 'error');
                    return;
                }

                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    showNotification('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞', 'error');
                    return;
                }

                selectPointOnMap([lat, lng]);
                showNotification('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 'success');
            });

            // –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É
            document.getElementById('searchAddressBtn').addEventListener('click', async function() {
                const address = document.getElementById('addressInput').value.trim();

                if (!address) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å', 'error');
                    return;
                }

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        selectPointOnMap([lat, lng]);
                        showNotification('–ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω', 'success');
                    } else {
                        showNotification('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞', 'error');
                }
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
            document.getElementById('saveTerritoryBtn').addEventListener('click', saveTerritory);

            // Enter –¥–ª—è –∞–¥—Ä–µ—Å–∞
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('searchAddressBtn').click();
                }
            });
        }

        function updatePointInfo() {
            if (!selectedPoint) return;

            document.getElementById('pointCoords').textContent =
                `${selectedPoint.lat.toFixed(6)}, ${selectedPoint.lng.toFixed(6)}`;

            document.getElementById('pointStatus').textContent = '–í—ã–±—Ä–∞–Ω–∞';
            document.getElementById('pointStatus').style.color = 'var(--accent-green)';
        }

        function updateMapInstructions(method) {
            const instructions = document.getElementById('mapInstructions');
            switch(method) {
                case 'map':
                    instructions.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞';
                    break;
                case 'coords':
                    instructions.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"';
                    break;
                case 'address':
                    instructions.textContent = '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ"';
                    break;
            }
        }

        function getUserEmail() {
            if (!currentUser) return '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';

            const user = users.find(u => u.username === currentUser.username);
            if (!user) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';

            if (user.notificationEmails && user.notificationEmails.length > 0) {
                const primaryEmail = user.notificationEmails.find(e => e.isPrimary);
                if (primaryEmail) return primaryEmail.address;
                return user.notificationEmails[0].address;
            }

            return user.username || currentUser.login || 'email_–Ω–µ_—É–∫–∞–∑–∞–Ω';
        }

        function saveToTextFile(territoryData) {
            const userEmail = getUserEmail();
            const content = `lat: ${territoryData.center.lat}\nlon: ${territoryData.center.lng}\n\nEmail: ${userEmail}`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = `—Ç–æ—á–∫–∞_${territoryData.center.lat.toFixed(6).replace('.', '_')}_${territoryData.center.lng.toFixed(6).replace('.', '_')}.txt`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        async function saveTerritory() {
            if (!currentUser) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                document.getElementById('authModal').classList.add('active');
                return;
            }

            if (!selectedPoint) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
                return;
            }

            const name = document.getElementById('territoryName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

            // 1. –°–û–•–†–ê–ù–Ø–ï–ú –í –ë–ê–ó–£ –î–ê–ù–ù–´–• –°–ï–†–í–ï–†–ê (–≥–ª–∞–≤–Ω–æ–µ!)
            try {
                console.log('üì° –°–æ—Ö—Ä–∞–Ω—è—é —Ç–æ—á–∫—É –≤ —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ë–î...');

                const response = await fetch('/api/territories/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: name,
                        lat: selectedPoint.lat,
                        lng: selectedPoint.lng,
                        description: `–¢–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${currentUser.username}`
                    })
                });

                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                if (!data.success) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î: ' + data.message, 'error');
                    return;
                }

                // 2. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                const serverTerritory = data.territory;
                console.log(' –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î —Å–µ—Ä–≤–µ—Ä–∞, ID:', serverTerritory.id);

                const territory = {
                    id: serverTerritory.id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞!
                    name: name,
                    type: 'point',
                    center: {
                        lat: selectedPoint.lat,
                        lng: selectedPoint.lng
                    },
                    date: new Date().toLocaleDateString('ru-RU'),
                    time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                    user: currentUser.username || currentUser.login,
                    server_id: serverTerritory.id, // –î—É–±–ª–∏—Ä—É–µ–º ID –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    source: 'server' // –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Ç–æ—á–∫–∞
                };

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ localStorage
                savedTerritories.push(territory);
                localStorage.setItem('cosmosTerritories', JSON.stringify(savedTerritories));

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                const saveBtn = document.getElementById('saveTerritoryBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î!';
                saveBtn.style.background = '#10b981';

                showNotification(`–¢–æ—á–∫–∞ "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!`, 'success');

                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                }, 3000);

                // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
                setTimeout(() => {
                    if (marker) map.removeLayer(marker);
                    selectedPoint = null;
                    document.getElementById('pointStatus').textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
                    document.getElementById('pointStatus').style.color = '';
                    document.getElementById('pointCoords').textContent = '‚Äî';
                    saveBtn.disabled = true;
                    document.getElementById('territoryName').value = '–ú–æ—è —Ç–æ—á–∫–∞';
                }, 2000);

            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î', 'error');
            }
        }

    </script>
</body>
</html>